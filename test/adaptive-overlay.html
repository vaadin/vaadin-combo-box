<!doctype html>
<html>

<head>
  <meta charset="UTF-8">
  <title>vaadin-combo basic tests</title>
  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <script src="../../test-fixture/test-fixture-mocha.js"></script>

  <link rel="import" href="common.html">
  <script src="common.js"></script>
</head>

<body>

  <test-fixture id="overlay">
    <template>
      <div style="width: 100px; height: 100px;">
        <vaadin-adaptive-overlay>
          <div class="content">content</div>
        </vaadin-adaptive-overlay>
      </div>
    </template>
  </test-fixture>


  <script>
    describe('overlay modes', function() {
      var overlay;
      var content;
      var dropdownContent;
      var viewportInfo;

      beforeEach(function() {
        overlay = fixture('overlay').firstElementChild;
        content = Polymer.dom(overlay).querySelector('.content');
        dropdownContent = Polymer.dom(overlay.root).querySelector('.dropdown-content');
        viewportInfo = document.querySelector('meta[name="viewport"]');
      });

      describe('fullscreen', function() {

        beforeEach(function(done) {
          overlay.fullScreen = true;
          overlay.open();
          Polymer.Base.async(done);
        });

        it('should have correct dimensions', function() {
          var rect = overlay.$.dropdown.getBoundingClientRect();
          expect(rect.left).to.equal(0);
          expect(rect.top).to.equal(0);
          expect(dropdownContent.clientWidth).to.equal(document.documentElement.clientWidth);
          expect(dropdownContent.clientHeight).to.equal(document.documentElement.clientHeight);
        });

        it('should alter the viewport info', function(done) {
          expect(viewportInfo.content).to.equal(overlay._viewportInfo._fullScreenContent);
          overlay.close();
          Polymer.Base.async(function() {
            expect(viewportInfo.content).not.to.equal(overlay._viewportInfo._fullScreenContent);
            done();
          });
        });

        describeIf(ios, 'fullscreen ios', function() {
          it('should have correct target elements', function() {
            expect(overlay.$.dropdown.positionTarget).to.equal(null);
          });

          it('should have position absolute', function() {
            expect(window.getComputedStyle(overlay.$.dropdown, null).position).to.equal('absolute');
          });
        });

        describeSkipIf(ios, 'fullscreen not ios', function() {
          it('should have position fixed', function() {
            expect(window.getComputedStyle(overlay.$.dropdown, null).position).to.equal('fixed');
          });

          it('should have correct target elements', function() {
            expect(overlay.$.dropdown.positionTarget).to.equal(null);
          });
        });

      });

      describe('non-fullscreen', function() {

        beforeEach(function(done) {
          overlay.fullScreen = false;
          overlay.open();
          Polymer.Base.async(done);
        });

        it('should have correct target elements', function() {
          expect(overlay.$.dropdown.positionTarget).to.equal(null);
        });

        it('should have the same width as container has', function() {
          expect(overlay.$.dropdown.clientWidth).to.equal(100);
        });

        it('should have the height as content has', function() {
          // we have a 8px margin for the overlay.
          expect(overlay.$.dropdown.clientHeight).to.equal(content.clientHeight + 8);
        });

        it('should not alter the viewport info', function() {
          expect(viewportInfo.content).not.to.equal(overlay._viewportInfo._fullScreenContent);
        });

        it('should have device pixel accurate vertical coordinate for dropdown', function(done) {
          overlay.close();

          // Give offset by irrational number of pixels, that never results
          // into interger device pixel-accurate value when rendering
          overlay.parentElement.style.marginTop = Math.E + 'px';

          overlay.parentElement.style.float = 'left'; // disables margins collapsing

          var interval = setInterval(function() {
            if (overlay.$.dropdown._openChangedAsync) {
              return;
            }

            var target = overlay.$.dropdown.getBoundingClientRect().top;

            // When multiplied by `devicePixelRatio`, target should be integer
            expect(target * (window.devicePixelRatio || 1) % 1).to.be.equal(0);

            // Cleanup the inline styles
            overlay.parentElement.style.removeProperty('margin-top');
            overlay.parentElement.style.removeProperty('float');

            clearInterval(interval);
            done();
          }, 100);

          overlay.open();
        });

      });

    });
  </script>

</body>

</html>
