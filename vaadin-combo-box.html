<!--
@license
Copyright (c) 2015 Vaadin Ltd.
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<!--
`<vaadin-combo-box>` is a combo box element combining a dropdown list with an
input field for filtering the list of items.

Items in the dropdown list must be provided as a list of `String` values.
Defining the items is done using the `items` property, which can be assigned
with data-binding, using an attribute or directly with the JavaScript property.

```html
<vaadin-combo-box
    label="Fruit"
    items="[[data]]">
</vaadin-combo-box>
```

```js
combobox.items = ['apple', 'orange', 'banana'];
```

When the selected `value` is changed, a `value-changed` event is triggered.

This element is also extended with the `IronFormElementBehavior` to
enable usage within an `iron-form`.

### Styling
There are custom properties and mixins you can use to style the component:

Custom property | Description | Default
----------------|-------------|-------------
`--vaadin-combo-box-overlay-max-height` | Property that determines the max height of overlay | `65vh`

@element vaadin-combo-box
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-input/iron-input.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-validatable-behavior/iron-validatable-behavior.html">
<link rel="import" href="../iron-a11y-announcer/iron-a11y-announcer.html">
<link rel="import" href="../paper-input/paper-input-behavior.html">
<link rel="import" href="../paper-input/paper-input-container.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="vaadin-combo-box-behavior.html">
<link rel="import" href="vaadin-combo-box-overlay.html">

<dom-module id="vaadin-combo-box">
  <style>
    :host {
       display: block;
       padding: 8px 0;
    }

    :host > #overlay {
      display: none;
    }

    paper-input-container {
      position: relative;
      padding: 0;
    }

    :host([opened]) paper-input-container {
      /* Keep the paper-input-container above the dropdown. */
      z-index: 20;
    }

    paper-icon-button.clear-button,
    paper-icon-button.toggle-button,
    :host ::content paper-icon-button.clear-button,
    :host ::content paper-icon-button.toggle-button {
      position: absolute;
      bottom: -4px;
      right: -4px;

      line-height: 18px !important;
      width: 32px;
      height: 32px;
      padding: 4px;
      text-align: center;

      color: rgba(0, 0, 0, .38);
      cursor: pointer;
      margin-top: -1px;
      --paper-icon-button-ink-color: rgba(0, 0, 0, .54);
    }

    paper-input-container paper-icon-button.clear-button,
    paper-input-container ::content paper-icon-button.clear-button {
      right: 28px;
    }

    paper-input-container paper-icon-button:hover,
    paper-input-container ::content paper-icon-button:hover,
    :host([opened]) paper-input-container paper-icon-button,
    :host([opened]) paper-input-container ::content paper-icon-button {
      color: rgba(0, 0, 0, .54);
    }

    :host([opened]) paper-input-container ::content paper-icon-button:hover,
    :host([opened]) paper-input-container paper-icon-button:hover {
      color: rgba(0, 0, 0, .86);
    }

    .rotate-on-open,
    :host ::content .rotate-on-open {
      transition: all 0.2s !important;
    }

    :host([opened]) .rotate-on-open,
    :host([opened]) ::content .rotate-on-open {
      -webkit-transform: rotate(180deg);
      transform: rotate(180deg);
    }

    paper-icon-button.small,
    :host ::content paper-icon-button.small {
      box-sizing: content-box !important;
      bottom: -6px;
      width: 20px;
      height: 20px;
      padding: 4px 6px 8px;
    }

    :host(:not([opened])) ::content .clear-button,
    :host(:not([opened])) .clear-button,
    :host(:not([has-value])) ::content .clear-button,
    :host(:not([has-value])) .clear-button {
      display: none;
    }

    :host([readonly]) ::content .toggle-button,
    :host([readonly]) .toggle-button,
    :host([disabled]) ::content .toggle-button,
    :host([disabled]) .toggle-button {
      display: none;
    }

    #input::-ms-clear {
      display: none;
    }

    #input {
      box-sizing: border-box;
      padding-right: 28px;
    }

    :host([opened][has-value]) #input {
      padding-right: 60px;
      margin-right: -32px;
    }

  </style>

  <template>
    <paper-input-container
          id="inputContainer"
          disabled$="[[disabled]]"
          no-label-float="[[noLabelFloat]]"
          always-float-label="[[_computeAlwaysFloatLabel(alwaysFloatLabel,placeholder)]]"
          auto-validate$="[[autoValidate]]"
          invalid="[[invalid]]"
          on-down="_preventDefault">
      <label id="label" hidden$="[[!label]]" aria-hidden="true" on-tap="open">[[label]]</label>

      <content select="[prefix]"></content>

      <input
          is="iron-input"
          id="input"
          type="text"
          role="combobox"
          autocomplete="off"
          autocapitalize="none"
          bind-value="{{_inputElementValue}}"
          aria-labelledby$="[[_ariaLabelledBy]]"
          aria-describedby$="[[_ariaDescribedBy]]"
          aria-activedescendant$="[[_ariaActiveIndex]]"
          aria-expanded$="[[_getAriaExpanded(opened)]]"
          aria-autocomplete="list"
          aria-owns="overlay"
          title$="[[title]]"
          disabled$="[[disabled]]"
          invalid="{{invalid}}"
          prevent-invalid-input="[[preventInvalidInput]]"
          allowed-pattern="[[allowedPattern]]"
          pattern$="[[pattern]]"
          required$="[[required]]"
          autofocus$="[[autofocus]]"
          inputmode$="[[inputmode]]"
          name$="[[name]]"
          placeholder$="[[placeholder]]"
          readonly$="[[readonly]]"
          size$="[[size]]"
          on-input="_inputValueChanged"
          on-blur="_onBlur"
          key-event-target>

      <content select="[suffix]"></content>

      <content select=".clear-button">
        <paper-icon-button
            id="clearIcon"
            tabindex="-1"
            icon="clear"
            on-touchend="_preventDefault"
            class="clear-button small">
        </paper-icon-button>
      </content>

      <content select=".toggle-button">
        <paper-icon-button
            id="toggleIcon"
            tabindex="-1"
            icon="arrow-drop-down"
            aria-controls="overlay"
            on-touchend="_preventDefault"
            class="toggle-button rotate-on-open">
        </paper-icon-button>
      </content>

      <template is="dom-if" if="[[errorMessage]]">
        <paper-input-error>[[errorMessage]]</paper-input-error>
      </template>
    </paper-input-container>

    <vaadin-combo-box-overlay
        id="overlay"
        _aria-active-index="{{_ariaActiveIndex}}"
        position-target="[[_getPositionTarget()]]"
        _focused-index="[[_focusedIndex]]"
        _item-label-path="[[itemLabelPath]]"
        on-down="_onOverlayDown"
        vertical-offset="2">
    </vaadin-combo-box-overlay>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'vaadin-combo-box',

    behaviors: [
      vaadin.elements.combobox.ComboBoxBehavior,
      Polymer.PaperInputBehavior
    ],

    attached: function() {
      this.inputElement = this.$.input;

      // Use the default toggle/clear or one replaced in light DOM.
      this._toggleElement = Polymer.dom(this).querySelector('.toggle-button') || this.$.toggleIcon;
      this._clearElement = Polymer.dom(this).querySelector('.clear-button') || this.$.clearIcon;
    },

    // document.activeElement doesn't return elements from inside shadow root
    _focusedInput: function() {
      return Polymer.dom(this.root).querySelector('input:focus');
    },

    _getPositionTarget: function() {
      return this.$.inputContainer;
    },

    /**
     * WAI-ARIA
     */

    _getAriaExpanded: function(value) {
      return value.toString();
    },

    _preventDefault: function(e) {
      e.preventDefault();
    }
  });

</script>
