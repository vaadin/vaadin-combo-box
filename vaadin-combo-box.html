<!--
@license
Copyright (c) 2017 Vaadin Ltd.
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<link rel="import" href="../polymer/polymer-element.html">

<link rel="import" href="../iron-input/iron-input.html">
<link rel="import" href="../iron-a11y-announcer/iron-a11y-announcer.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../vaadin-text-field/vaadin-text-field.html">
<link rel="import" href="vaadin-combo-box-mixin.html">
<link rel="import" href="vaadin-combo-box-overlay.html">
<link rel="import" href="vaadin-combo-box-shared-styles.html">
<link rel="import" href="vaadin-combo-box-icons.html">

<dom-module id="vaadin-combo-box">
  <template>
    <style include="vaadin-combo-box-shared-styles">
      :host {
        display: block;
        padding: 8px 0;
      }

      :host > #overlay {
        display: none;
      }

      paper-icon-button.clear-button,
      paper-icon-button.toggle-button,
      :host ::slotted(paper-icon-button[slot="toggle-button"]),
      :host ::slotted(paper-icon-button[slot="clear-button"]) {
        line-height: 18px !important;
        width: 32px;
        height: 32px;
        padding: 4px;
        text-align: center;

        color: rgba(0, 0, 0, .38);
        cursor: pointer;
        margin-top: -1px;
        --paper-icon-button-ink-color: rgba(0, 0, 0, .54);
      }

      :host [slot=suffix] {
        display: flex;
      }
    </style>

    <vaadin-text-field id="input"
        invalid="{{invalid}}"

        bind-value="{{_inputElementValue}}"
        allowed-pattern="[[allowedPattern]]"
        prevent-invalid-input="[[preventInvalidInput]]"

        value="{{_inputElementValue}}"
        autocomplete="off"

        role="combobox"
        invalid="[[invalid]]"
        label="[[label]]"
        name="[[name]]"
        placeholder="[[placeholder]]"
        required="[[required]]"
        disabled="[[disabled]]"
        readonly="[[readonly]]"
        error-message="[[errorMessage]]"

        autocapitalize="none"
        aria-expanded$="[[_getAriaExpanded(opened)]]"
        aria-autocomplete="list"

        aria-label$="[[label]]"
        autofocus="[[autofocus]]"
        inputmode="[[inputmode]]"

        on-blur="_onBlur"
        on-change="_stopPropagation"
        on-input="_inputValueChanged"
        on-tap="_openAsync"
        key-event-target
      >
      <slot name="prefix" slot="prefix"></slot>

      <slot name="suffix" slot="suffix"></slot>

      <div slot="suffix">
        <span>
          <slot name="clear-button">
            <paper-icon-button id="clearIcon"
              tabindex="-1"
              aria-label="Clear"
              icon="vaadin-combo-box:clear"
              class="clear-button small">
            </paper-icon-button>
          </slot>
        </span>
        <span>
          <slot name="toggle-button">
            <paper-icon-button id="toggleIcon"
              tabindex="-1"
              icon="vaadin-combo-box:arrow-drop-down"
              aria-label="Toggle"
              aria-expanded$="[[_getAriaExpanded(opened)]]"
              class="toggle-button rotate-on-open">
            </paper-icon-button>
          </slot>
        </span>
      </div>

    </vaadin-text-field>

    <vaadin-combo-box-overlay id="overlay"
      opened=[[opened]]
      position-target="[[_getPositionTarget()]]"
      _focused-index="[[_focusedIndex]]"
      _item-label-path="[[itemLabelPath]]"
      on-down="_onOverlayDown"
      loading="[[loading]]"
      vertical-offset="2">
    </vaadin-combo-box-overlay>
  </template>
</dom-module>

  <script>
    if (!Polymer.Element) {
      throw new Error(`Unexpected Polymer version ${Polymer.version} is used, expected v2.0.0 or later.`);
    }

    {
      /**
       * `<vaadin-combo-box>` is a combo box element combining a dropdown list with an
       * input field for filtering the list of items. If you want to replace the default
       * input field with a custom implementation, you should use the
       * [`<vaadin-combo-box-light>`](#vaadin-combo-box-light) element.
       *
       * Items in the dropdown list must be provided as a list of `String` values.
       * Defining the items is done using the `items` property, which can be assigned
       * with data-binding, using an attribute or directly with the JavaScript property.
       *
       * ```html
       * <vaadin-combo-box
       *     label="Fruit"
       *     items="[[data]]">
       * </vaadin-combo-box>
       * ```
       *
       * ```js
       * combobox.items = ['apple', 'orange', 'banana'];
       * ```
       *
       * When the selected `value` is changed, a `value-changed` event is triggered.
       *
       * This element can be used within an `iron-form`.
       *
       * ### Item Template
       *
       * `<vaadin-combo-box>` supports using custom item template provided in the light
       * DOM:
       *
       * ```html
       * <vaadin-combo-box items='[{"label": "Hydrogen", "value": "H"}]'>
       *   <template>
       *     [[index]]: [[item.label]] <b>[[item.value]</b>
       *   </template>
       * </vaadin-combo-box>
       * ```
       *
       * The following properties are available for item template bindings:
       *
       * Property name | Type | Description
       * --------------|------|------------
       * `index`| Number | Index of the item in the `items` array
       * `item` | String or Object | The item reference
       * `selected` | Boolean | True when item is selected
       * `focused` | Boolean | True when item is focused
       *
       * See the [Item Template Live Demos](demo/item-template.html) for more examples.
       *
       * ### Styling
       * There are custom properties and mixins you can use to style the component:
       *
       * Custom property | Description | Default
       * ----------------|-------------|-------------
       * `--vaadin-combo-box-overlay-max-height` | Property that determines the max height of overlay | `65vh`
       *
       * @memberof Vaadin
       * @mixes Vaadin.ComboBoxMixin
       * @demo demo/index.html
       */
      class ComboBoxElement extends Vaadin.ComboBoxMixin(Polymer.Element) {

        static get is() {
          return 'vaadin-combo-box';
        }

        static get properties() {
          return {
            /**
             * The label for this element.
             */
            label: {
              type: String,
              reflectToAttribute: true
            },

            /**
             * Set to true to disable the floating label.
             */
            noLabelFloat: {
              type: Boolean,
              value: false
            },

            /**
             * Set to true to always float the label.
             */
            alwaysFloatLabel: {
              type: Boolean,
              value: false
            },

            /**
             * Set to true to disable this input.
             */
            disabled: {
              type: Boolean,
              value: false
            },

            /**
             * Set to true to prevent the user from entering invalid input.
             */
            preventInvalidInput: {
              type: Boolean
            },

            /**
             * Set this to specify the pattern allowed by `preventInvalidInput`.
             */
            allowedPattern: {
              type: String
            },

            /**
             * A pattern to validate the `input` with.
             */
            pattern: {
              type: String
            },

            /**
             * The error message to display when the input is invalid.
             */
            errorMessage: {
              type: String
            },

            autofocus: {
              type: Boolean
            },

            inputmode: {
              type: String
            },

            /**
             * A placeholder string in addition to the label. If this is set, the label will always float.
             */
            placeholder: {
              type: String,
              // need to set a default so _computeAlwaysFloatLabel is run
              value: ''
            },

            readonly: {
              type: Boolean,
              value: false
            },

            size: {
              type: Number
            },

            /**
             * True when the input field has focus.
             */
            focused: {
              type: Boolean,
              value: false,
              readOnly: true,
              reflectToAttribute: true,
              notify: true
            }
          };
        }

        attributeChanged(name, type) {
          // Safari has an issue with repainting shadow root element styles when a host attribute changes.
          // Need this workaround (toggle any inline css property on and off) until the issue gets fixed.
          const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
          if (isSafari && this.root) {
            Array.prototype.forEach.call(this.root.querySelectorAll('*'), el => {
              el.style['-webkit-backface-visibility'] = 'visible';
              el.style['-webkit-backface-visibility'] = '';
            });
          }
        }

        ready() {
          super.ready();
          // 2.0 does not support nested syntax for listeners
          this.$.input.addEventListener('focused-changed', this._onInputContainerFocusedChanged.bind(this));

          this._setInputElement(this.$.input);
          this._bindableInput = this.$.input;
          this._nativeInput = this.$.input.focusElement;
        }

        connectedCallback() {
          super.connectedCallback();
          // Use the default toggle/clear or one replaced in light DOM.
          this._toggleElement = this.querySelector('[slot=toggle-button]') || this.$.toggleIcon;
          this._clearElement = this.querySelector('[slot=clear-button]') || this.$.clearIcon;
          this._preventInputBlur();
        }

        disconnectedCallback() {
          super.disconnectedCallback();
          this._restoreInputBlur();
        }

        _computeAlwaysFloatLabel(alwaysFloatLabel, placeholder) {
          return placeholder || alwaysFloatLabel;
        }

        _getPositionTarget() {
          return this.$.input;
        }

        _getAriaExpanded(value) {
          return value.toString();
        }

        /**
         * Sets focus on the input field.
         */
        focus() {
          this.inputElement.focus();
        }

        /**
         * Removes focus from the input field.
         */
        blur() {
          this.inputElement.blur();
        }

        _onInputContainerFocusedChanged(e) {
          this._setFocused(e.detail.value);
        }
      }

      customElements.define(ComboBoxElement.is, ComboBoxElement);

      /**
       * @namespace Vaadin
       */
      window.Vaadin = window.Vaadin || {};
      Vaadin.ComboBoxElement = ComboBoxElement;
    }
  </script>
</dom-module>


