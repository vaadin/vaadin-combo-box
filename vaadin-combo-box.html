<!--
@element vaadin-combo-box
-->

<link rel='import' href='../polymer/polymer.html'>
<link rel='import' href='../paper-input/paper-input-container.html'>
<link rel='import' href='../iron-input/iron-input.html'>
<link rel='import' href='../iron-icons/iron-icons.html'>
<link rel='import' href='../iron-icon/iron-icon.html'>
<link rel='import' href='../iron-form-element-behavior/iron-form-element-behavior.html'>
<link rel='import' href='../iron-validatable-behavior/iron-validatable-behavior.html'>
<link rel="import" href="../iron-list/iron-list.html">
<link rel='import' href='vaadin-adaptive-overlay.html'>

<dom-module id='vaadin-combo-box'>
  <style>
    /* Temporary styles */

    #selector {
      background: #FFF;
    }

    .item {
      cursor: pointer;
      padding: 16px 22px;
      border-bottom: 1px solid #DDD;
    }

    .item:hover {
      background: #EEE;
    }

    .item[selected] {
      background-color: var(--google-grey-100);
    }

    :host ::content #dropdown:not([fullscreen]) paper-input-container {
      display: none;
    }
  </style>

  <template>
    <paper-input-container on-tap='open'>
      <input id='input' is='iron-input' bind-value='[[value]]' name$='[[name]]' type='text' required$="[[required]]" on-bind-value-changed='_inputValueChanged' autocomplete="off">
      <iron-icon icon='arrow-drop-down' suffix></iron-icon>
    </paper-input-container>

    <vaadin-adaptive-overlay id='overlay' opened={{opened}}>
      <paper-input-container>
        <input id='fullScreenInput' is='iron-input' bind-value='[[value]]' on-bind-value-changed='_fullScreenInputValueChanged'>
        <iron-icon icon='arrow-drop-down' on-tap='close' suffix></iron-icon>
      </paper-input-container>
      <iron-list id='selector' items='[[items]]' selected-item='[[value]]' on-selected-item-changed='_selectedItemChanged' selection-enabled>
        <template>
          <div selected$=[[selected]] class='item'>[[item]]</div>
        </template>
      </iron-list>
    </vaadin-adaptive-overlay>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'vaadin-combo-box',

    behaviors: [
      Polymer.IronFormElementBehavior,
      Polymer.IronValidatableBehavior
    ],

    properties: {
      /**
       * True if the dropdown is open, false otherwise.
       */
      opened: {
        type: Boolean,
        notify: true,
        value: false,
        observer: '_openedChanged'
      },
      /**
       * The value for this element.
       */
      value: {
        type: String,
        notify: true,
        observer: 'close'
      }
    },

    ready: function() {
      var sel = this.$.selector;
      this.$.overlay.addEventListener('vaadin-adaptative-overlay-opened', function() {
      });
      this.$.overlay.addEventListener('vaadin-adaptative-overlay-closed', function() {
        sel.clearSelection();
      });
    },

    /**
     * Open the overlay.
     */
    open: function() {
      this._selectItemByOffset(0);
    },

    _fullScreenInputValueChanged: function(event) {
      this.$.input.bindValue = event.detail.value;
    },

    _inputValueChanged: function() {
      if(this._isFiltering()) {
        if(!this.opened) {
          this.open();
        }

        if(this.items) {
          this.$.selector.items = this._filter(this.items);
          this.$.selector.selectedItem = this.value;
          this._selectItem(this.$.selector.items[0]);
        }
      }
    },

    _filter: function(arr) {
      return arr.filter(function(item) {
        // Check if item contains input value.
        return item.indexOf(this.$.input.bindValue) > -1;
      }.bind(this));
    },

    _selectedItemChanged: function() {
      if (!this._handingSelection) {
        var _val = this.$.selector.selectedItem;
        if (_val !== null) {
          this.value = _val;
        }
      }
    },

    _openedChanged: function() {
      if (this.opened) {
        this.$.selector.items = this.items;
      } else {
        this.$.input.bindValue = this.value;
      }
    },

    _isFiltering: function() {
      return this.$.input.bindValue != this.value;
    },

    /**
     * Close the overlay.
     */
    close: function() {
      this.$.overlay.close();
    },

    /**
    * Validates the input element and sets an error style if needed.
    *
    * @return {boolean}
    */
    _getValidity: function(){
      return this.$.input.validate();
    },

    listeners: {
      'keydown': '_onKeydown'
    },

    _handingSelection: false,

    _selectItem: function(item) {
      this._handingSelection = true;
      this.$.selector.clearSelection();
      try {
        this.$.selector.selectItem(item);
        // ignore iron-list: Uncaught TypeError: <item> should be a valid item
      } catch(ignore) {
      }
      this._handingSelection = false;
    },

    _selectItemByOffset: function(offset) {
      var val = this.$.selector.selectedItem || this.$.input.value;
      if (val) {
        this._selectItem(val);
      }
      if (!this.opened) {
        this.$.overlay.open();
        if (offset) return;
      }
      if (!offset) {
        return;
      }
      var its = this.$.selector.items;
      var idx = offset + its.indexOf(val);
      if (idx >= 0 && idx < its.length) {
        this._selectItem(its[idx]);
      }
    },

    _moveCursorByOffset: function(offset) {
      var i = this.$.input;
      var l = i.value.length;
      var s = i.selectionStart;
      var o = s + offset
      if (o >= 0 && o <= l && s != o) {
        i.setSelectionRange(o, o);
      }
    },

    _onKeydown: function(event) {
      if (!event.metaKey && !event.ctrlKey && !event.altKey) {
        switch (event.keyCode) {
        case 37: // left
          event.preventDefault();
          this._moveCursorByOffset(-1);
          break
        case 39: // rigth
          event.preventDefault();
          this._moveCursorByOffset(+1);
          break
        case 38: // up
          event.preventDefault();
          var n = this._selectItemByOffset(-1);
          break;
        case 40: // down
          event.preventDefault();
          var n = this._selectItemByOffset(+1);
          break;
        case 27: // escape
          // Do nothing since iron-dropdown handles it
          break;
        case 13: // enter
          if (this.opened) {
            event.preventDefault();
            this.value = this.$.selector.selectedItem;
          } else if (!this.$.input.value) {
            // FIXME: this never happens, how to clear the input ?
            event.preventDefault();
            this.$.selector.clearSelection();
            this.close();
          }
        }
      }
    },

  });
</script>
