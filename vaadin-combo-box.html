<!--
@license
Copyright (c) 2015 Vaadin Ltd.
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<!--
`<vaadin-combo-box>` is a combo box element combining a dropdown list with an
input field for filtering the list of items. If you would like to use a custom
input field, see [`<vaadin-combo-box-light>`](#vaadin-combo-box-light).

Items in the dropdown list must be provided as a list of `String` values.
Defining the items is done using the `items` property, which can be assigned
with data-binding, using an attribute or directly with the JavaScript property.

```html
<vaadin-combo-box
    label="Fruit"
    items="[[data]]">
</vaadin-combo-box>
```

```js
combobox.items = ['apple', 'orange', 'banana'];
```

When the selected `value` is changed, a `value-changed` event is triggered.

This element is also extended with the `IronFormElementBehavior` to
enable usage within an `iron-form`.

### Styling
There are custom properties and mixins you can use to style the component:

Custom property | Description | Default
----------------|-------------|-------------
`--vaadin-combo-box-overlay-max-height` | Property that determines the max height of overlay | `65vh`

@element vaadin-combo-box
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-input/iron-input.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-validatable-behavior/iron-validatable-behavior.html">
<link rel="import" href="../iron-a11y-announcer/iron-a11y-announcer.html">
<link rel="import" href="../paper-input/paper-input-behavior.html">
<link rel="import" href="../paper-input/paper-input-container.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="vaadin-combo-box-behavior.html">
<link rel="import" href="vaadin-combo-box-overlay.html">
<link rel="import" href="vaadin-combo-box-shared-styles.html">

<dom-module id="vaadin-combo-box">
  <style include="vaadin-combo-box-shared-styles">
    :host {
       display: block;
       padding: 8px 0;
    }

    :host > #overlay {
      display: none;
    }

    paper-input-container {
      position: relative;
      padding: 0;
    }

    :host([opened]) paper-input-container {
      /* Keep the paper-input-container above the dropdown. */
      z-index: 20;
    }

    #input::-ms-clear {
      display: none;
    }

    #input {
      box-sizing: border-box;
      padding-right: 28px;
    }

    :host([opened][has-value]) #input {
      padding-right: 60px;
      margin-right: -32px;
    }

  </style>

  <template>
    <paper-input-container
          id="inputContainer"
          disabled$="[[disabled]]"
          no-label-float="[[noLabelFloat]]"
          always-float-label="[[_computeAlwaysFloatLabel(alwaysFloatLabel,placeholder)]]"
          auto-validate$="[[autoValidate]]"
          invalid="[[invalid]]"
          on-down="_preventDefault">
      <label id="label" hidden$="[[!label]]" aria-hidden="true" on-tap="open">[[label]]</label>

      <content select="[prefix]"></content>

      <input
          is="iron-input"
          id="input"
          type="text"
          role="combobox"
          autocomplete="off"
          autocapitalize="none"
          bind-value="{{_inputElementValue}}"
          aria-labelledby$="[[_ariaLabelledBy]]"
          aria-describedby$="[[_ariaDescribedBy]]"
          aria-activedescendant$="[[_ariaActiveIndex]]"
          aria-expanded$="[[_getAriaExpanded(opened)]]"
          aria-autocomplete="list"
          aria-owns="overlay"
          title$="[[title]]"
          disabled$="[[disabled]]"
          invalid="{{invalid}}"
          prevent-invalid-input="[[preventInvalidInput]]"
          allowed-pattern="[[allowedPattern]]"
          pattern$="[[pattern]]"
          required$="[[required]]"
          autofocus$="[[autofocus]]"
          inputmode$="[[inputmode]]"
          name$="[[name]]"
          placeholder$="[[placeholder]]"
          readonly$="[[readonly]]"
          size$="[[size]]"
          on-input="_inputValueChanged"
          on-blur="_onBlur"
          key-event-target>

      <content select="[suffix]"></content>

      <content select=".clear-button">
        <paper-icon-button
            id="clearIcon"
            tabindex="-1"
            icon="clear"
            on-touchend="_preventDefault"
            class="clear-button small">
        </paper-icon-button>
      </content>

      <content select=".toggle-button">
        <paper-icon-button
            id="toggleIcon"
            tabindex="-1"
            icon="arrow-drop-down"
            aria-controls="overlay"
            on-touchend="_preventDefault"
            class="toggle-button rotate-on-open">
        </paper-icon-button>
      </content>

      <template is="dom-if" if="[[errorMessage]]">
        <paper-input-error>[[errorMessage]]</paper-input-error>
      </template>
    </paper-input-container>

    <vaadin-combo-box-overlay
        id="overlay"
        _aria-active-index="{{_ariaActiveIndex}}"
        position-target="[[_getPositionTarget()]]"
        _focused-index="[[_focusedIndex]]"
        _item-label-path="[[itemLabelPath]]"
        on-down="_onOverlayDown"
        vertical-offset="2">
    </vaadin-combo-box-overlay>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'vaadin-combo-box',

    behaviors: [
      vaadin.elements.combobox.ComboBoxBehavior,
      Polymer.PaperInputBehavior
    ],

    attached: function() {
      this._inputElement = this.$.input;

      // Use the default toggle/clear or one replaced in light DOM.
      this._toggleElement = Polymer.dom(this).querySelector('.toggle-button') || this.$.toggleIcon;
      this._clearElement = Polymer.dom(this).querySelector('.clear-button') || this.$.clearIcon;
    },

    // document.activeElement doesn't return elements from inside shadow root
    _focusedInput: function() {
      return Polymer.dom(this.root).querySelector('input:focus');
    },

    _getPositionTarget: function() {
      return this.$.inputContainer;
    },

    /**
     * WAI-ARIA
     */

    _getAriaExpanded: function(value) {
      return value.toString();
    }
  });

</script>
