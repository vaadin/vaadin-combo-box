<!--
@element vaadin-adaptive-overlay
-->

<link rel='import' href='../polymer/polymer.html'>
<link rel='import' href='../iron-dropdown/iron-dropdown.html'>

<dom-module id="vaadin-adaptive-overlay">
  <style>
    #dropdown[fullscreen],
    #dropdown[fullscreen]::content #contentWrapper,
    #dropdown[fullscreen] .dropdown-content {
      height: 100vh;
      max-height: 100vh;
      width: 100vw;
      max-width: 100vw;
    }

    :host .dropdown-content {
      width: 100vw;
    }
  </style>

  <template>
    <iron-dropdown id="dropdown"
      opened={{opened}}
      focus-target=[[focusTarget]]
      fullscreen$=[[fullScreen]]
      with-backdrop=[[fullScreen]]
      on-iron-overlay-closed="_closed"
      on-iron-overlay-opened="_opened"
      vertical-align="[[verticalAlign]]"
      horizontal-align="[[horizontalAlign]]"
      vertical-offset="[[verticalOffset]]">
      <div id='dropdownContent' class="dropdown-content">
        <content>
      </div>
    </iron-dropdown>
  </template>
</dom-module>

<script>
  Polymer({
    is: "vaadin-adaptive-overlay",

    properties: {
      /**
       * True if the overlay is open, false otherwise.
       */
      opened: {
        type: Boolean,
        notify: true,
        value: false
      },

      /**
       * True if the overlay works in full screen mode (e.g. on mobile devices).
       */
      fullScreen: {
        type: Boolean,
        observer: '_fullScreenChanged',
        notify: true,
        reflectToAttribute: true,
        value: function() {
          try {
            document.createEvent("TouchEvent");
            return true;
          } catch (e) {
            return false;
          }
        }
      },

      /**
       * Current viewport config
       */
      _viewportInfo: {
        readOnly: true,
        value: function() {
          var viewport = document.querySelector('meta[name="viewport"]');
          if (!viewport) {
            viewport = document.createElement("meta");
            viewport.setAttribute("name", "viewport");
            document.querySelector('head').appendChild(viewport);
          }
          viewport._originalContent = viewport.content;
          viewport._fullScreenContent =
            "width=device-width, minimum-scale=1.0, maximum-scale=1.0, initial-scale=1, user-scalable=no";
          return viewport;
        }
      },

      alignmentTarget: {
        type: Object
      },

      /**
       * The pixel value that being compared with bottom offset of the input element will
       * make the popup be shown above the input.
       */
      alignThreshold: {
        type: Number,
        value: 200
      },

      _alignedToBottom: {
        type: Boolean,
        value: false
      }
    },

    /**
     * Called when the value of `fullScreen` changes.
     *
     */
    _fullScreenChanged: function() {
      this.$.dropdown.positionTarget = this.fullScreen ? document.documentElement : this;
    },

    /**
     * Need to monkeypatch _sizeDimension to avoid a bug in iron-fit-behavior
     */
    _patchIronFitBehavior: function() {
      var sd = this.$.dropdown._sizeDimension.bind(this.$.dropdown);
      this.$.dropdown._sizeDimension = function(rect, positionedBy, start, end, extent) {
        if(extent === "Width") {
          var parent = this.domHost || this.parentElement;
          this.$.dropdown.sizingTarget.style.maxWidth = parent.clientWidth + 'px';

          // iron-dropdown should do this
          var a = this.$.dropdown.verticalAlign === 'top' ? 'bottom' : 'top';
          this.$.dropdown.style[a] = 'auto';
        } else {
          sd(rect, positionedBy, start, end, extent);
        }
      }.bind(this);
    },

    ready: function() {
      this._patchIronFitBehavior();
    },

    _resizeHandler: undefined,

    attached: function() {
      this._fullScreenChanged();
    },

    /**
     * Open the overlay.
     */
    open: function() {
      this._resizeHandler = this._updateOverlayAlignment.bind(this);
      window.addEventListener('resize', this._resizeHandler);
      window.addEventListener('scroll', this._resizeHandler);
      this.$.dropdown.open();
    },

    /**
     * Close the overlay.
     */
    close: function() {
      if (this._resizeHandler) {
        window.removeEventListener('resize', this._resizeHandler);
        window.removeEventListener('scroll', this._resizeHandler);
      }
      this.$.dropdown.close();
    },

    /**
     * Called when an `iron-overlay-opened` event fires.
     */
    _opened: function() {
      if (this.fullScreen) {
        this._viewportInfo.content = this._viewportInfo._fullScreenContent;
      } else {
        // FIXME(manolo) for some reason in tests after beforeEach has be run, if
        // we call combobox.open() this.alignmentTarget seems undefined and we cannot
        // call updateOverlayAlignment(). Using hack right now
        Polymer.Base.async(function() {
          var ev = document.createEvent('Event');
          ev.initEvent('resize', true, true);
          window.dispatchEvent(ev);
        })
        // Polymer.Base.async(this.updateOverlayAlignment);
      }
    },

    /**
     * Called when an `iron-overlay-closed` event fires.
     */
    _closed: function() {
      if (this.fullScreen) {
        this._viewportInfo.content = this._viewportInfo._originalContent;
      }
    },

    _updateOverlayAlignment: function() {
      if (!this.alignmentTarget || this.fullScreen) return;

      var rect = this.alignmentTarget.getBoundingClientRect();

      var bottomAlign = window.innerHeight - rect.bottom < this.alignThreshold;
      this.verticalAlign = bottomAlign ? 'bottom' : 'top';
      this.verticalOffset = bottomAlign ? rect.height : 0;

      if (bottomAlign !== this._alignedToBottom) {
        if (this.opened) {
          this.close();
          this.$.dropdown.resetFit();
          Polymer.Base.async(this.open.bind(this));
        } else {
          this.$.dropdown.resetFit();
        }
      }
      this._alignedToBottom = bottomAlign;
    }

  });
</script>
